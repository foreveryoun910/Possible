<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.possable.app.rent.mapper.RentHistoryMapper">
	
	<resultMap id="rentHistory" type="RentHistoryVO">
		<id property="seq" column="seq" />
		<result property="rentType" column="rent_type" />
		<result property="startDate" column="start_date" />
		<result property="endDate" column="end_date" />
		<result property="receiver" column="receiver" />
		<result property="price" column="price" />
		<result property="estimate" column="estimate" />
		<result property="status" column="status" />
		<result property="genDate" column="gen_date" />
		<result property="uptDate" column="upt_date" />
		<result property="takePlaceCode" column="take_place_code" />
		<result property="takePlaceBasic" column="take_place_basic" />
		<result property="takePlaceDetail" column="take_place_detail" />
		<result property="merchantUid" column="merchant_uid" />
		<result property="payMethod" column="pay_method" />
		<result property="phone" column="phone" />
		<result property="birth" column="birth" />
		<result property="email" column="email" />
		<result property="receiverB" column="receiver_b" />
		<result property="phoneB" column="phone_b" />
		<result property="birthB" column="birth_b" />
		<result property="emailB" column="email_b" />
		<result property="carBrand" column="car_brand"/>
		<result property="carModel" column="car_model"/>
		<result property="carSegment" column="car_segment"/>
		<result property="cmpnName" column="cmpn_name"/>
        <result property="cmpnTel" column="cmpn_tel"/>
		<association property="carVO"
	    			 column= "car_seq"	
	    			 select="com.yedam.possable.app.car.mapper.CarMapper.getCar"
	    			 javaType="CarVO"/>
	    			  
		<association property="memberVO"
	                 column="mem_seq"
	                 select="com.yedam.possable.app.member.mapper.MemberMapper.memberOneSelect"
	                 javaType="MemberVO"/>
	                 
		<association property="companyVO"
                     column="cmpn_seq"
                     select="com.yedam.possable.app.company.mapper.CompanyMapper.companyOneSelect"
                     javaType="CompanyVO"/>
        
        <association property="brandCodeVO"
                     column="brand"
                     select="com.yedam.possable.app.common.code.mapper.CodeMapper.getBrand"
                     javaType="BrandCodeVO"/>
        
        <association property="segmentCodeVO"
                     column="segment"
                     select="com.yedam.possable.app.common.code.mapper.CodeMapper.getCodeByValue"
                     javaType="CodeSubVO"/>
        
        <association property="modelCodeVO"
                     column="model"
                     select="com.yedam.possable.app.common.code.mapper.CodeMapper.getModel"
                     javaType="ModelCodeVO"/>
        
        <association property="trimCodeVO"
                     column="trim"
                     select="com.yedam.possable.app.common.code.mapper.CodeMapper.getTrim"
                     javaType="TrimCodeVO"/>
                                  
	</resultMap>
	
	<!-- 업체 렌트내역 리스트 -->
	<select id="getRentHistoryList" resultMap="rentHistory">
             SELECT
             /*+ INDEX_DESC(RENT_HISTORY IDX_RENT_HISTORY) */
             ROWNUM RN, SEQ,
						CAR_SEQ,
						MEM_SEQ,
						RENT_TYPE,
						START_DATE,
						END_DATE,
						RECEIVER,
						TAKE_PLACE_CODE,
						PRICE,
						ESTIMATE,
						STATUS,
						GEN_DATE,
						UPT_DATE,
						TAKE_PLACE_DETAIL,
						TAKE_PLACE_BASIC,
						MERCHANT_UID,
						PAY_METHOD,
						CMPN_SEQ
             FROM RENT_HISTORY
             WHERE CMPN_SEQ = #{cmpnSeq}
	</select>
	
	<!-- 업체 렌트내역 한건 -->
	<select id="getRentHistory" resultType="RentHistoryVO">
             SELECT		SEQ,
						CAR_SEQ,
						MEM_SEQ,
						RENT_TYPE,
						START_DATE,
						END_DATE,
						RECEIVER,
						TAKE_PLACE_CODE,
						PRICE,
						ESTIMATE,
						STATUS,
						GEN_DATE,
						UPT_DATE,
						TAKE_PLACE_DETAIL,
						TAKE_PLACE_BASIC,
						MERCHANT_UID,
						PAY_METHOD
             FROM RENT_HISTORY
             WHERE SEQ = #{seq}
	</select>
	<!-- 마이페이지 한건 조회 -->
	<select id="getRentHistoryInMypage" resultMap="rentHistory">
		SELECT * FROM 
		RENT_HISTORY
        WHERE SEQ = #{seq}
      
	</select>
	
	<select id="getHistoryCount" resultType="int">
        SELECT COUNT(*)
        FROM RENT_HISTORY
    </select>
    <select id="MyPageRentHistoryList" resultMap="rentHistory">
    	SELECT * 
		FROM(
        	SELECT  
        	/*+ INDEX_DESC(RENT_HISTORY IDX_RENT_HISTORY) */
       		ROWNUM RN,
       		rh.SEQ,
       		rh.TAKE_PLACE_BASIC,
       		rh.TAKE_PLACE_DETAIL,
	        rh.PAY_METHOD,
	        rh.PRICE,
	        rh.MERCHANT_UID,
	        rh.START_DATE,
	        rh.END_DATE,
	        rh.STATUS,
	        a.brand AS car_brand,
	        a.model AS car_model,
	        a.segment AS car_segment,
	        c.name  AS cmpn_name,
	        c.TEl AS cmpn_tel,
       		<![CDATA[case When (SELECT count(*) FROM RENT_REVIEW where HISTORY_SEQ = rh.seq) > 0 	THEN '2'
						  When trunc(END_DATE) < trunc(sysdate) then '1' 
						  else '0' end]]> AS review 
	       FROM RENT_HISTORY rh INNER JOIN MEMBER m
	       ON rh.MEM_SEQ = m.seq
	             INNER JOIN COMPANY c
	       ON rh.CMPN_SEQ = c.SEQ      
	             INNER JOIN CAR a
	       ON rh.CAR_SEQ= a.SEQ
       <where>
       		<![CDATA[   AND ROWNUM <= #{cri.pageNum} * #{cri.amount} ]]>
       </where>
       and rh.mem_seq = #{seq}
      )
      	WHERE RN > (#{cri.pageNum} - 1) * #{cri.amount}
    </select>
</mapper>