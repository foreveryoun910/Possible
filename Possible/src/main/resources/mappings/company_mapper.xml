<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.possable.app.company.mapper.CompanyMapper">
    <sql id="criteria">
        <trim prefix="(" suffix=")" prefixOverrides="OR">
            <foreach collection="typeArr" item="type">
                <trim prefix="OR">
                    <choose>
                        <when test="type == 'N'.toString()">
                            NAME LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test="type == 'A'.toString()">
                            AREA LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test="type == 'C'.toString()">
                            CMPN_NUM LIKE '%' || #{keyword} || '%'
                        </when>
                        <when test="type == 'T'.toString()">
                            TEL LIKE '%' || #{keyword} || '%'
                        </when>

                    </choose>
                </trim>
            </foreach>
        </trim>
    </sql>

    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM COMPANY
        <where>
            <include refid="criteria">
            </include>
        </where>
    </select>

    <!-- 업체 등록 -->
    <insert id="companyReg">
        <selectKey keyProperty="seq" resultType="long" order="BEFORE">
            SELECT SEQ_COMPANY.nextval FROM DUAL
        </selectKey>
        INSERT INTO COMPANY(
        SEQ,
        NAME,
        POSTAL,
        CMPN_NUM,
        TEL,
        STATUS,
        GEN_DATE,
        UPT_DATE,
        MEM_SEQ,
        ADDR1,
        ADDR2,
        AREA)
        VALUES(
        #{seq},
        #{name},
        #{postal},
        #{cmpnNum},
        #{tel},
        'PST02',
        sysdate,
        sysdate,
        #{memSeq},
        #{addr1},
        #{addr2},
        #{area}
        )
    </insert>

    <!-- 업체 미승인 리스트 -->
    <select id="companyRegList" resultType="CompanyVO">
        SELECT
                /*+ INDEX_DESC (COMPANY IDX_COMPANY) */
                ROWNUM RN,
                SEQ,
                NAME,
                POSTAL,
                CMPN_NUM,
                ADDR1,
                ADDR2,
                AREA,
                TEL
        FROM COMPANY
        WHERE STATUS = 'PST02'
    </select>

    <!-- 업체 승인 리스트 -->
    <select id="companyList" resultType="CompanyVO">
        SELECT
        /*+ INDEX_DESC(COMPANY IDX_COMPANY) */
        ROWNUM RN, SEQ,
        NAME,
        POSTAL,
        CMPN_NUM,
        ADDR1,
        ADDR2,
        AREA,
        TEL,
        STATUS
        FROM COMPANY
        <where>
            <include refid="criteria">
            </include>
            <![CDATA[
            AND STATUS = 'PST01' OR STATUS = 'PST03'
            AND ROWNUM <= #{pageNum} * #{amount} ]]>
        </where>
    </select>

    <!-- 업체 한건-->
    <select id="companyOneSelect" resultType="CompanyVO">
        SELECT SEQ,
               MEM_SEQ,
               NAME,
               POSTAL,
               CMPN_NUM,
               TEL,
               ADDR1,
               ADDR2,
               AREA,
               STATUS,
               GEN_DATE,
               UPT_DATE
        FROM COMPANY
        WHERE SEQ = #{seq}
    </select>

    <!-- 업체 승인 변경 -->
    <update id="companyRegUpdate">
        UPDATE COMPANY
        SET STATUS   = 'PST01',
            UPT_DATE = sysdate
        WHERE SEQ = #{seq}
    </update>

    <!-- 업체 승인 거부 -->
    <update id="companyRegDelete">
        UPDATE COMPANY
        SET STATUS   = 'PST03',
            UPT_DATE = sysdate
        WHERE SEQ = #{seq}
    </update>

    <select id="getCompanyByMemSeq" resultType="CompanyVO">
        SELECT *
        FROM company
        WHERE mem_seq = #{seq}
    </select>

    <select id="getCompanyItems" resultType="string">
        SELECT opt_code
        FROM item_option
        WHERE cmpn_seq = #{seq}
    </select>

    <!-- 업체 업체정보수정(휴대폰번호,이메일,주소) -->
	<update id="companyInfoUpdate">
	UPDATE COMPANY SET NAME = #{name},
				  TEL = #{tel},
                  ADDR1 = #{addr1},
                  ADDR2 = #{addr2},
                  AREA = #{area}
	WHERE SEQ = #{seq}
	</update>

    <!-- 수익차트... -->
    <select id="companyIncome" resultType="java.util.HashMap">
	select to_char(trunc(r.gen_date),'YYYYMMDD') gen_date, sum(r.price) price
	from rent_history r join car c
	on r.car_seq = c.seq
	where c.cmpn_seq = 1
	group by to_char(trunc(r.gen_date),'YYYYMMDD'), c.cmpn_seq
	order by to_char(trunc(r.gen_date),'YYYYMMDD')
    </select>
</mapper>

